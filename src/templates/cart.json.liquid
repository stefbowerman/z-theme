{% comment %} Improved cart JSON response which includes full product info for cart items {% endcomment %}

{% layout none %}
{
  "total_price": {{ cart.total_price }},
  "original_total_price": {{ cart.original_total_price }},
  "total_discount": {{ cart.total_discount }},
  "note": {{ cart.note | json }},
  "item_count": {{ cart.item_count }},
  "items" : [
    {% for item in cart.items %}
      {% assign product = item.product %}
      {
        "id": {{ product.id }},
        "title": {{ item.title | json }},
        "price": {{ product.price }},
        "line_price": {{ item.price }},
        "quantity": {{ item.quantity }},
        "sku": {{ item.sku | json }},
        "vendor": {{ item.vendor | json }},
        {% unless item.properties == empty %}
          "properties": {
            {% for property in item.properties %}
              {{ property.first | json }}: {{ property.last | json }}
              {% unless forloop.last %},{% endunless %}
            {% endfor %}
          }
        {% endunless %},
        "variant_id": {{ item.variant_id | json }},
        "gift_card": {{ item.gift_card }},
        "url": {{ item.url | json }},
        "image": {{ item.image | json }},
        "handle": {{ product.handle | json }},
        "requires_shipping": {{ item.requires_shipping }},
        "product": {{ product | json }},
        "product_title": {{ product.title | json }},
        "product_description": {{ product.description | json }},
        "product_type": {{ product.type | json }},
        "variant_title": {{ item.variant.title | json }},
        {% if item.variant.option1 != blank or item.variant.option2 != blank or item.variant.option3 != blank %}
          "variant_options": [
            {% if item.variant.option1 != blank %}{{ item.variant.option1 | json }}{% endif %}
            {% if item.variant.option2 != blank %}, {{ item.variant.option2 | json }}{% endif %}
            {% if item.variant.option3 != blank %}, {{ item.variant.option3 | json }}{% endif %}
          ],
        {% endif %}
        "metafields": {
          "_": 0 {% comment %} Add an extra field here to ensure we don't have a dangling comma {% endcomment %}
        }
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}